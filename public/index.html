<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escrow Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .left-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }

    .right-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fafafa;
    }

    h1, h2, h3 {
      margin-bottom: 15px;
    }

    h1 {
      font-size: 24px;
      color: #2d5016;
    }

    h2 {
      font-size: 18px;
      color: #4a7c2c;
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }

    input, select {
      width: 100%;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: #333;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4a7c2c;
    }

    button {
      padding: 10px 20px;
      background: #5a9c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }

    button:hover {
      background: #4a8a32;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .escrow-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }

    .escrow-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      width: 100%;
    }

    .escrow-id {
      font-weight: bold;
      color: #2d5016;
    }

    .escrow-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-PROPOSED { background: #e8e8e8; color: #666; }
    .status-FUNDED { background: #d4edda; color: #2d5016; }
    .status-DISPUTED { background: #f8d7da; color: #721c24; }
    .status-RELEASED { background: #5a9c3c; color: #fff; }
    .status-REFUNDED { background: #e2e3e5; color: #383d41; }

    .escrow-details {
      font-size: 13px;
      color: #666;
    }

    .escrow-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }

    .action-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: #4a7c2c;
    }

    .action-btn:hover {
      background: #3d6b26;
    }

    .events-log {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .event-entry {
      padding: 4px 8px;
      margin-bottom: 4px;
      background: #fff;
      border-left: 2px solid #4a7c2c;
      border-radius: 2px;
      font-size: 11px;
      line-height: 1.5;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event-type {
      color: #2d5016;
      font-weight: 600;
      font-size: 11px;
    }

    .event-time {
      color: #999;
      font-size: 11px;
    }

    .role-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .role-option {
      flex: 1;
    }

    .role-option input[type="radio"] {
      width: auto;
      margin-right: 5px;
    }

    .role-option label {
      margin: 0;
      cursor: pointer;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
      border: 1px solid #f5c6cb;
    }

    .success-message {
      background: #d4edda;
      color: #2d5016;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
      border: 1px solid #c3e6cb;
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      color: #666;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      color: #4a7c2c;
      background: #f0f0f0;
    }

    .tab-btn.active {
      color: #2d5016;
      border-bottom-color: #4a7c2c;
      background: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <h1>Escrow Manager</h1>

      <div id="messages"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="create">Create Escrow</button>
        <button class="tab-btn" data-tab="list">My Escrows</button>
      </div>

      <!-- Create Tab -->
      <div id="create-tab" class="tab-content active">
        <h2>Create New Escrow</h2>
        <form id="createEscrowForm">
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="amount" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Buyer</label>
          <select id="buyerId" required></select>
        </div>
        <div class="form-group">
          <label>Seller</label>
          <select id="sellerId" required></select>
        </div>
        <div class="form-group">
          <label>Arbiter</label>
          <select id="arbiterId" required></select>
        </div>
        <button type="submit">Create Escrow</button>
      </form>
      </div>

      <!-- List Tab -->
      <div id="list-tab" class="tab-content">
        <div id="roleSelectorContainer"></div>
        <h2>Existing Escrows</h2>
        <div id="escrowsList"></div>
      </div>
    </div>

    <div class="right-panel">
      <h1>Events Log</h1>
      <div id="eventsLog" class="events-log"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/escrow';
    let users = [];
    let escrows = [];
    let currentRole = 'buyer';

    // Fetch all users
    async function fetchUsers() {
      // For now, use the dummy users from the database
      users = [
        { user_id: 0, name: 'Alice' },
        { user_id: 1, name: 'Bob' },
        { user_id: 2, name: 'Charlie' },
        { user_id: 3, name: 'Dave' }
      ];
      populateUserSelects();
    }

    function populateUserSelects() {
      const buyerSelect = document.getElementById('buyerId');
      const sellerSelect = document.getElementById('sellerId');
      const arbiterSelect = document.getElementById('arbiterId');

      buyerSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.name} (ID: ${u.user_id})</option>`).join('');
      sellerSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.name} (ID: ${u.user_id})</option>`).join('');
      arbiterSelect.innerHTML = users.map(u => `<option value="${u.user_id}">${u.name} (ID: ${u.user_id})</option>`).join('');

      // Set default values
      buyerSelect.value = '0';
      sellerSelect.value = '1';
      arbiterSelect.value = '2';
    }

    // Create new escrow
    async function createEscrow(e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('amount').value);
      const buyerId = parseInt(document.getElementById('buyerId').value);
      const sellerId = parseInt(document.getElementById('sellerId').value);
      const arbiterId = parseInt(document.getElementById('arbiterId').value);

      try {
        const response = await fetch(`${API_BASE}/metadata`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, buyer_id: buyerId, seller_id: sellerId, arbiter_id: arbiterId })
        });

        if (response.ok) {
          showMessage('Escrow created successfully!', 'success');
          document.getElementById('createEscrowForm').reset();
          populateUserSelects();
          fetchEscrows();
          fetchEvents();
        } else {
          const error = await response.json();
          showMessage(`Error: ${error.error || 'Failed to create escrow'}`, 'error');
        }
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      }
    }

    // Fetch all escrows
    async function fetchEscrows() {
      try {
        const response = await fetch(`${API_BASE}/metadata`);
        const data = await response.json();

        // Fetch details for each escrow
        escrows = await Promise.all(
          data.data.map(async (metadata) => {
            const res = await fetch(`${API_BASE}/metadata/${metadata.escrow_id}`);
            const escrowData = await res.json();
            return escrowData;
          })
        );

        renderEscrows();
      } catch (error) {
        console.error('Error fetching escrows:', error);
      }
    }

    // Render escrows list
    function renderEscrows() {
      const container = document.getElementById('escrowsList');

      if (escrows.length === 0) {
        container.innerHTML = '<p style="color: #666;">No escrows found</p>';
        return;
      }

      container.innerHTML = escrows.map(escrow => {
        const metadata = escrow.metadata;
        const state = escrow.current_state;
        const events = escrow.events;

        // Determine available actions based on current state and selected role
        const availableActions = getAvailableActions(state, currentRole);

        return `
          <div class="escrow-card">
            <div class="escrow-header">
              <span class="escrow-id">Escrow #${metadata.escrow_id}</span>
              <span class="escrow-status status-${state}">${state}</span>
            </div>
            <div class="escrow-details">
              Amount: $${metadata.amount}<br>
              Buyer: ${getUserName(metadata.buyer_id)} | Seller: ${getUserName(metadata.seller_id)} | Arbiter: ${getUserName(metadata.arbiter_id)}
            </div>
            <div class="escrow-actions">
              ${availableActions.map(action => `
                <button class="action-btn" onclick="performAction(${metadata.escrow_id}, '${action}', ${getUserIdForRole(metadata, currentRole)})">
                  ${actionToVerb(action)}
                </button>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function getAvailableActions(state, role) {
      const actions = [];
      const roleMap = {
        'PROPOSED': { buyer: ['FUNDED'], seller: [], arbiter: [] },
        'FUNDED': { buyer: ['DISPUTED'], seller: ['DISPUTED'], arbiter: [] },
        'DISPUTED': { buyer: [], seller: [], arbiter: ['RELEASED', 'REFUNDED'] },
        'RELEASED': { buyer: [], seller: [], arbiter: [] },
        'REFUNDED': { buyer: [], seller: [], arbiter: [] }
      };

      if (roleMap[state] && roleMap[state][role]) {
        actions.push(...roleMap[state][role]);
      }

      return actions;
    }

    function actionToVerb(action) {
      const verbs = {
        'FUNDED': 'Fund',
        'DISPUTED': 'Dispute',
        'RELEASED': 'Release',
        'REFUNDED': 'Refund'
      };
      return verbs[action] || action;
    }

    function getUserIdForRole(metadata, role) {
      switch (role) {
        case 'buyer': return metadata.buyer_id;
        case 'seller': return metadata.seller_id;
        case 'arbiter': return metadata.arbiter_id;
        default: return metadata.buyer_id;
      }
    }

    function getUserName(userId) {
      const user = users.find(u => u.user_id === userId);
      return user ? user.name : `User ${userId}`;
    }

    // Perform an action on an escrow
    async function performAction(escrowId, action, userId) {
      try {
        const response = await fetch(`${API_BASE}/action/${escrowId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, user_id: userId })
        });

        if (response.ok) {
          showMessage(`Action "${action}" performed successfully!`, 'success');
          fetchEscrows();
          fetchEvents();
        } else {
          const error = await response.json();
          showMessage(`Error: ${error.error || 'Failed to perform action'}`, 'error');
        }
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      }
    }

    // Fetch all events
    async function fetchEvents() {
      try {
        const response = await fetch(`${API_BASE}/events`);
        const data = await response.json();
        renderEvents(data.data);
      } catch (error) {
        console.error('Error fetching events:', error);
      }
    }

    // Render events log
    function renderEvents(events) {
      const container = document.getElementById('eventsLog');

      if (events.length === 0) {
        container.innerHTML = '<p style="color: #999;">No events</p>';
        return;
      }

      container.innerHTML = events.map(event => {
        const date = new Date(event.created_at);
        const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        // Build event data string if present
        let dataStr = '';
        if (event.event_data && Object.keys(event.event_data).length > 0) {
          const dataParts = [];
          if (event.event_data.buyer_id !== undefined) dataParts.push(`buyer: ${event.event_data.buyer_id}`);
          if (event.event_data.seller_id !== undefined) dataParts.push(`seller: ${event.event_data.seller_id}`);
          if (event.event_data.arbiter_id !== undefined) dataParts.push(`arbiter: ${event.event_data.arbiter_id}`);
          if (event.event_data.amount !== undefined) dataParts.push(`amt: $${event.event_data.amount}`);
          if (dataParts.length > 0) {
            dataStr = ` (${dataParts.join(', ')})`;
          }
        }

        // Shorten event type
        const eventType = event.event_type
          .replace('Escrow', '')
          .replace('Proposed', 'Created')
          .replace('Funded', 'Funded')
          .replace('Released', 'Released')
          .replace('Disputed', 'Disputed')
          .replace('Refunded', 'Refunded');

        return `
          <div class="event-entry">
            <span style="color: #999; font-size: 11px;">${timeStr}</span>
            <span class="event-type">${eventType}</span>
            <span style="color: #666;">#${event.escrow_id}</span>
            <span style="color: #999;">by user ${event.user_id}</span>
            <span style="color: #666;">${dataStr}</span>
          </div>
        `;
      }).join('');
    }

    function showMessage(message, type) {
      const container = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      container.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Role selector for testing
    function createRoleSelector() {
      const container = document.getElementById('roleSelectorContainer');
      const selector = document.createElement('div');
      selector.className = 'role-selector';
      selector.innerHTML = `
        <div style="color: #aaa; font-size: 14px; align-self: center;">Act as:</div>
        <div class="role-option">
          <input type="radio" id="role-buyer" name="role" value="buyer" checked>
          <label for="role-buyer">Buyer</label>
        </div>
        <div class="role-option">
          <input type="radio" id="role-seller" name="role" value="seller">
          <label for="role-seller">Seller</label>
        </div>
        <div class="role-option">
          <input type="radio" id="role-arbiter" name="role" value="arbiter">
          <label for="role-arbiter">Arbiter</label>
        </div>
      `;

      container.appendChild(selector);

      // Add event listeners to radio buttons
      document.querySelectorAll('input[name="role"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          currentRole = e.target.value;
          renderEscrows();
        });
      });
    }

    // Tab switching
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.getAttribute('data-tab');

          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked button and corresponding content
          button.classList.add('active');
          document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Initialize
    document.getElementById('createEscrowForm').addEventListener('submit', createEscrow);
    fetchUsers();
    fetchEscrows();
    fetchEvents();
    createRoleSelector();
    setupTabs();

    // Auto-refresh events every 5 seconds
    setInterval(fetchEvents, 5000);
  </script>
</body>
</html>
